<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/blog/libs/highlight/github.min.css"> <!-- <script src="https://unpkg.com/lunr/lunr.js"></script> <script src="/blog/libs/lunr/lunr.min.js"></script> <script src="/blog/libs/lunr/lunr_index.js"></script> <script src="/blog/libs/lunr/lunrclient.min.js"></script> --> <link rel=stylesheet  type="text/css" href="https://cdn.jsdelivr.net/gh/aaaakshat/cm-web-fonts@latest/fonts.css"> <link rel=stylesheet  href="/blog/css/franklin.css"> <link rel=stylesheet  href="/blog/css/basic.css"> <link rel=stylesheet  href="/blog/css/custom.css"> <link rel=stylesheet  href="/blog/css/katex_custom.css"> <link rel=stylesheet  href="/blog/css/admonitions.css"> <link rel=icon  href="/blog/assets/favicon.ico"> <title>Using NGINX with Titan2 to launch capsules</title> <header> <div class=blog-name ><a href="/blog/"><code style="font-size:20px;">/var/log/fjebaker.log</code></a></div> <div class=blog-header > <div> <div id=menu-nav > <nav> <ul> <li><a href="/blog/">Home</a> </ul> </nav> </div> <!-- <div style="margin-right: 0.5em;"> <form id=lunrSearchForm  name=lunrSearchForm > <input class=search-input  name=q  placeholder="Enter search term" type=text > <input type=submit  value=Search  formaction="/blog/search/index.html"> </form> </div> --> </div> </div> </header> <div class=franklin-content ><h1 id=using_nginx_with_titan2_to_launch_capsules ><a href="#using_nginx_with_titan2_to_launch_capsules" class=header-anchor >Using NGINX with Titan2 to launch capsules</a></h1> <p><em>This post is cross-posted from my gemini capsule: <code>gemini://gemlog.cosroe.com</code>.</em></p> <p>This is a short guide to self-hosting a Gemini capsule on a Raspberry Pi &#40;optionally with docker&#41;. An NGINX image is used to direct traffic to an upstream Titan2 Gemini file server.</p> <p><a href="https://gitlab.com/lostleonardo/titan2">lostleonardo&#39;s Titan2 Gemini server</a></p> <p>The Raspberry Pi I am planning to use I am already &#40;ab&#41;using with multiple services. Unfortunately, at time of writing there is an electronic components shortage, which has made it extremely difficult &#40;and expensive&#41; to procure more hardware to run these services on – my motivation therefore lies in creating something I can easily move to a different machine without having to spend time reconfiguring the setup, once/if the shortage is addressed. Consequently, I will be using docker to spawn the NGINX server, but this is not at all required – the mechanism by which the service is spawned is irrelevant, though for posterity I have included docker scripts at the end for those similarly interested. </p> <p>The motivation for using NGINX relates to load-balancing, centralised logging, and to co-exist with HTTP servers. I won&#39;t cover how to set those things up in this post.</p> <p>I am using:</p> <ul> <li><p>Raspberry Pi 4 &#40;4GB&#41;</p> <li><p>64-bit Raspberry Pi OS </p> </ul> <h2 id=nginx_setup ><a href="#nginx_setup" class=header-anchor >NGINX setup</a></h2> <p>The NGINX server is configured through a single nginx.conf file, inspired by panda-roux&#39;s NGINX setup</p> <p><a href="gemini://gemini.panda-roux.dev/log/entry">panda-roux&#39;s capsule</a></p> <pre><code class="julia hljs"><span class=hljs-comment ># conf/nginx.conf</span>
events {
    worker_connections <span class=hljs-number >1024</span>;
}
stream {
    <span class=hljs-comment ># Gemini server</span>

    map $ssl_preread_server_name  $name {
        gemlog.cosroe.com titan2_server;
    }
    
    server {
        listen <span class=hljs-number >1965</span>;
        ssl_preread on;
        proxy_buffer_size <span class=hljs-number >16</span>k;

        <span class=hljs-comment ># pass to the backend</span>
        proxy_pass $name;
    }

    upstream titan2_server {
        <span class=hljs-comment ># local IP address</span>
        server $titan_ip_addr:<span class=hljs-number >1961</span>;
    }
}</code></pre> <p>Note, &quot;titan<em>ip</em>addr&quot; in the &quot;upstream&quot; directive is localhost if the Titan2 instance is running on the same machine &#40;for docker, it will be the local ip address of that machine&#41;. It also redirects to port 1961, since NGINX will be listening on 1965.</p> <h2 id=titan2 ><a href="#titan2" class=header-anchor >Titan2</a></h2> <p>Titan2 is implemented in go, and so requires a go runtime. Installing this on a Raspberry Pi is straight forward; select the correct binaries, and then fetch:</p> <pre><code class="julia hljs">wget https://dl.google.com/go/go1<span class=hljs-number >.17</span><span class=hljs-number >.6</span>.linux-arm64.tar.gz -O go.tar.gz
sudo tar -C /usr/<span class=hljs-keyword >local</span> -xzf go.tar.gz

<span class=hljs-comment ># add env variables</span>
echo <span class=hljs-string >&quot;export GOPATH=<span class=hljs-variable >$HOME</span>/go&quot;</span> &gt;&gt; .bashrc
echo <span class=hljs-string >&quot;export PATH=/usr/local/go/bin:<span class=hljs-variable >$PATH</span>:<span class=hljs-variable >$GOPATH</span>/bin&quot;</span> &gt;&gt; .bashrc</code></pre> <p>Building the project is then very easy </p> <pre><code class="julia hljs">git clone <span class=hljs-string >&quot;https://gitlab.com/lostleonardo/titan2&quot;</span>
cd titan2
go install</code></pre> <p>In order to launch the capsule, we require self-signed certificates for our domain. These can be generated with openssl:</p> <pre><code class="julia hljs">mkdir -p certs
openssl req -x509 -newkey rsa:<span class=hljs-number >4096</span> \
    -keyout certs/key.rsa \
    -out certs/cert.pem \
    -days <span class=hljs-number >3650</span> -nodes \
    -subj <span class=hljs-string >&quot;/CN=gemlog.cosroe.com&quot;</span></code></pre> <p>Finally, we require some content to serve</p> <pre><code class="julia hljs">mkdir -p capsule \
    &amp;&amp; echo -e <span class=hljs-string >&quot;# Hello Gemini\nCapsule launched <span class=hljs-subst >$(date)</span>&quot;</span> \
    &gt; capsule/index.gmi</code></pre> <p>We are then ready to launch&#33;</p> <pre><code class="julia hljs">titan2 -hostname <span class=hljs-number >0.0</span><span class=hljs-number >.0</span><span class=hljs-number >.0</span> \
    -dir capsule \
    -crt certs/cert.pem \
    -key certs/key.rsa \
    -port <span class=hljs-number >1961</span></code></pre> <h2 id=docker_and_systemctl ><a href="#docker_and_systemctl" class=header-anchor >Docker and systemctl</a></h2> <p>NGINX can be configured as a systemctl service with a simple service file. When using docker &#40;as I am&#41;, this may look like</p> <pre><code class="julia hljs"><span class=hljs-comment ># nginx.service</span>
[Unit]
Description=NGINX Service
Requires=docker.service
After=docker.service

[Service]
<span class=hljs-built_in >Type</span>=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/docker run --name nginx --rm -d \
	-v /home/<span class=hljs-literal >pi</span>/conf/nginx.conf:/etc/nginx/nginx.conf \
	-p <span class=hljs-string >&quot;1965:1965&quot;</span> \
	nginx
ExecStop=/usr/bin/docker stop nginx
TimeoutStartSec=<span class=hljs-number >0</span>

[Install]
WantedBy=multi-user.target</code></pre> <p>To ensure Titan2 launches on startup, we can create a simple service file:</p> <pre><code class="julia hljs"><span class=hljs-comment ># titan2.service</span>
[Unit]
Description=titan2 gemini server
After=network.target

[Service]
User=<span class=hljs-literal >pi</span>
<span class=hljs-built_in >Type</span>=simple
ExecStart=/home/<span class=hljs-literal >pi</span>/go/bin/titan2 \
    -hostname <span class=hljs-number >0.0</span><span class=hljs-number >.0</span><span class=hljs-number >.0</span> \
     -dir /home/<span class=hljs-literal >pi</span>/capsule \
     -crt /home/<span class=hljs-literal >pi</span>/certs/cert.pem \
     -key /home/<span class=hljs-literal >pi</span>/certs/key.rsa \
     -port <span class=hljs-number >1961</span>

[Install]
WantedBy=default.target</code></pre> <p>Then we link and enable the services:</p> <pre><code class="julia hljs">sudo systemctl link $(pwd)/nginx.service
sudo systemctl link $(pwd)/titan2.service

sudo systemctl enable nginx titan2</code></pre> <div class=page-foot > <div class=copyright > &copy; Fergus Baker. Last modified: March 18, 2023. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div>